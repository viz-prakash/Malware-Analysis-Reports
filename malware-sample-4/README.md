Executive Summary
=================

The malware 131.exe, aka “Mamba”, is a Ransomware. It is a 32-bit
console based PE which executes on windows operating system. On
execution without valid arguments it executes as a harmless executable
and does nothing, but upon execution with 2 random arguments it does a
lot of illegitimate activities on machine. These activities include:
creation of a user named **mythbusters** and adding it to Administrator
group for persistence, installing a **dcrypt** driver which overshadows
the BIOS, if access is enabled, and asks to contact
**w889901665@yandex.com** for decrypting the HDD, installing service
named **DefragmentService**, installing a driver named **dcrypt**, and
rebooting the system without user consent. If bios access is not allowed
system restarts and forces to log in as **mythbusters** user and does
not allows to login on machine even as Administrator or Guest.
DefragmentService is installed with following registry keys:
**HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet001\\Services\\DefragmentService,
HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet002\\Services\\DefragmentService,
HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DefragmentService.**
Image path is same for all these entries which is path to the original
131.exe where it was executed from. Dcrypt driver is added with
following registry entries:
**HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet001\\Services\\dcrypt,
HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet002\\Services\\dcrypt,
HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\dcrypt.**
Image path is system32\\drivers\\dcrypt.sys for all the three entries.
It contains 13 resources under it resource section, all these are dlls,
exes or .sys(drivers) files. Many of them are reported as malware on
Virustotal, by looking up them by their hashes. It creates a directory
**C:\\DC22** and copy all its resources inside this directory form
memory. Name of the files copied are **dcrypt.sys, dcinst.exe,
dcrypt.exe, dcapi.dll, dccon.exe, log\_file.txt, Mount.exe, netpass.exe,
netpass.txt, and netuse.txt**. Whereas log\_file.txt is its log file.
This malware also copies dcrypt.sys driver to
**C:\\Windows\\system32\\drivers** directory. It has significant amount
of URL and email addresses in its strings but no network activity is
observed upon its execution or on reboot after its execution.

Basic Static Analysis
=====================

Static analysis of malware 131.exe tells that its MD5, and SHA256 sum is
409d80bb94645fbc4a1fa61c07806883, and
2ecc525177ed52c74ddaaacd47ad513450e85c01f2616bf179be5b576164bf63
respectively. It’s size is 2415104 bytes by PEstudio and ExeinfoPe.
Compilation date as per PEstudio is April 24 2:00:40 2016. This piece of
malware is not packed as per PEid, as well as ExeinfoPE. It is 32-bit
console based application as per ExeinfoPE, PEstudio and PEid. It’s
entropy is 6.1 by PEid. PEiD plugin Kanal report a lot of Cryptographic
constructs such as- Rijendael s-table and inverse s-table, SHA512, SHA1,
and CRC32. Entry point by PEid, ExeinfoPE, and PEstudio is 00008217.
Pestudio gives bunch of indicators listed following: installation of
hooks to change or control the behavior of system, use of authorization
functions, debugging functions, memory management functions, file
management functions, embeds 13 executables, manifest requires
Administrative permission and references to URLs. ASLR is enabled as per
PEstudio. All the sections are readable, only .data (data) section is
writable and only .text (Code) section is executable. Size of
.rsrc(resource) section is 2204424 bytes and it contains total 14
resources out which 13 are .sys, exes, or dlls. Report of individual
resources by Virus Total is listed below in table:

  Name            MD5 Hash                           Detection Ratio
  --------------- ---------------------------------- -----------------
  32DCCON.EXE     7972CC1402BED3DF8A0F2B88E8A46E51   0
  MOUNT.EXE       C43A77D0FE42BE421FA5F4B8ADAA2E09   41/61
  32DCINST.EXE    52143D89C9AD1A7B3344CA66F9AEB2AC   0
  32DCRYPT.EXE    683BECC76691F61166703E346A2F615B   0
  32NETPASS.EXE   70C5F9DF7AC735A0DB5861813F6FE9E8   44/61
  32DCAPI.DLL     F93C8DA34F2C03C8CCDC29343FDB4BE7   34/61
  32DCRYPT.SYS    B4E6D97DAFD9224ED9A547D52C26CE02   0
  64DCCON.EXE     1A1222101C499EB15F5C91774583D24D   0
  64NETPASS.EXE   3E392EB6159653CF776989AD3D3252D6   19/57
  64DCAPI.DLL     771660EF1E941ECD47FE5B64E0EDFCBB   38/57
  64DCINST.EXE    88F25E2F08C90B3BBE253D0D64AB1D3E   0
  64DCRYPT.EXE    2D2CDB3F89FA0D9E052E088AC74A25A2   0
  64DCRYPT.SYS    EDB72F4A46C39452D1A5414F7D26454A   0

Notable library imports are advapi32.dll, shlwapi.dll, kernel32.dll and
shell32.dll. Few of notable imported symbols are mentioned below in
table:

  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  Filesystem                                           **createFileExw, WriteFile, CopyFileExW**
  ---------------------------------------------------- ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  Import hiding                                        **LoadLibraryW, GetProcessAddress**

  Reading environment variables and system directory   **GetEnvironmentStrings, FreeEnvironmentStrings, GetEnvironmentVariableW, GetSystemDirectoryW.**

  Process and Thread                                   **CreateProcessW, CreateThread, ExitProcess, GetCurrentProcess(), OpenProcessToken(),GetCurrentProcessId(), CreateProcessAsUserW(), ImpersonateLoggedOnUser(), RevertToSelf()**

  Command Line parsing                                 **GetCommandLineA()**

  Console                                              **WriteConsoleW, ReadConsoleW, ExitWindowEx**

  **Resource**                                         **FindResourceW, LoadResourceW, SizeofResource**

  Exception Handling to Anti-Debugging                 **GetTickCount(), IsDebuggerPresent(), IsProcessorFeaturePresent(), UnhabdledExceptionFilter(), SetUnhabdledExceptionFilter(),OutputDebugString()**

  Network                                              **Ws2\_32.dll, WSAStartup(), socket(), send(), recv(), connect(), closesocket(), ntohl(), htonl()**

  Services                                             **OpenScManagerW(), CreateServiceW,** **StartServiceCtrlDispatcher(), ChangeServiceConfig2W(), SetServiceStatus(), RegisterServiceCtrlHandlerW()**
  --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

Suspicious Strings are categorized as below:

**Functions:** SetDefaultDllDirectories, Wow64DisbaleWow64FsRedirection,
GetCommandLine, LoatResource, CreateDirectory, LogonUser, RevertToSelf,
RegisterServiceCtrlHandler, LoadLibraryEx, GetProcAddress, dcrypt.pdb,
FLTMGR.SYS, GetLogicalDrives, SetVolumeMountPoint, IsWindowVisible,
RegCreateKey, RegQueryValueEx, RegOpenKey, RegDeleteValue, RegCloseKey,
RegSetValueEx, GetTickCount, OpenScManager, DeleteFIle, FreeLIbrary,
ZwQueryInformationFIle, FindFirstVolume, FindNextVolume,
SetWindowHookEx.

**Exe or Sys files:** .dcrypt.sys, .dcrypt.sys, 32dcrypt.sys,
32dcrypt.exe, dcrypt.exe, 32dcinst.exe, dcinst.exe, 32dccon.exe,
dccon.exe, 32dcapi.dll, dcapi.dll, Mount.exe, 32netpass.exe,
netpass.exe, 64dcrypt.sys, 64dcrypt.exe, 64dcinst.exe, 64dccon.exe,
64dcapi.dll, 64netpass.exe, \\dcinst.exe, SeShutdownPrivilege, ..exe,
.EXE, EC:\\DC22\\Mount.exe, \\dccon.exe, 32DCRYPT.SYS, 32DCRYPT.EXE,
32DCINST.EXE, 32DCCON.EXE, 32DCAPI.DLL, 32NETPASS.EXE, 64DCRYPT.SYS,
64DCRYPT.EXE, 64DCINST.EXE, 64DCCON.EXE, 64DCAPI.DLL, 64NETPASS.EXE,
MOUNT.EXE, dcrypt.sys, %s\\drivers\\%s.sys.

**Registry related strings:**
HKEY\_LOCAL\_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall
/reg:64, reg query,
HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet001\\Services\\.http://crl.thawte.com/ThawteTimestampingCA.crl0,
Software\\Microsoft\\Windows\\CurrentVersion\\Run.

**Strings:** “DiskCryptor 0.1-0.4 installed, please completely uninstall
it before use this version.SIL-compiled (/clr) function from a native
constructor or from DllMain.”, whole lot strings indicating Cryptography
constructs, .rsrc, Connection\_aborted, connection\_refused,
network\_reset, network\_down, network\_uncreachable,
C:\\DC22\\netpass.txt, C:\\DC22\\nepass.exe /stab C:\\DC22\\netpass.txt,
C:\\DC22\\Mount.exe, .cmd,.bat, .exe, .com.

**Cryptographic:** AES Instructions Set (AES-NI), Twofish.

**URLs:** +http://ts-aia.ws.symantec.com/tss-ca-g2.cer0&lt;,
+http://ts-crl.ws.symantec.com/tss-ca-g2.crl0(,
Dhttp://crl.microsoft.com/pki/crl/products/MicrosoftCodeVerifRoot.crl0,
http://ocsp.thawte.com0, http://ts-ocsp.ws.symantec.com07,
https://www.verisign.com/rpa0, http://ocsp.verisign.com0;,
https://www.verisign.com/cps0\*, https://www.verisign.com/rpa0,
http://ocsp.verisign.com0, http://diskcryptor.net/.

**Email address:** Vincent Rijmen
&lt;vincent.rijmen@esat.kuleuven.ac.be&gt;, Antoon Bosselaers
&lt;antoon.bosselaers@esat.kuleuven.ac.be&gt;, Paulo Barreto
&lt;paulo.barreto@terra.com.br&gt; , Tom St Denis
&lt;tomstdenis@gmail.com&gt; , Matthew Skala
&lt;mskala@ansuz.sooke.bc.ca&gt;, Dag Arne Osvik
&lt;osvik@ii.uib.no&gt;, Herbert Valerio Riedel &lt;hvr@gnu.org&gt; ,
Ruben Jesus Garcia Hernandez &lt;ruben@ugr.es&gt;.

Basic dynamic analysis
======================

On execution of malware 131.exe without any argument, it does nothing.
No interesting filesystem, registry, or network activity were found.
Program execute and exit quickly.

In-depth Static and Dynamic Analysis
====================================

As already mentioned, malware Mamba does nothing when executed without
any arguments. As it imports the symbol GetCommandLine() guess is it is
looking or command line arguments. Function Sub\_402240 checks the
number of arguments passed on execution, if it is not 2 it exits without
doing anything. So, passing two random arguments while execution of
program changes the execution flow of program to when it does something
illegal on the machine. Number of arguments passed to malware is 2 then
function Sub\_402240, hides the console by calling showWindow(0), then
calls Sub\_401E001(). Sub\_401E001 first checks whether system is 32 bit
or 64 bit and decides it course of action based upon it. If 32 bit it
uses 32 bit resources from resource section else 64 bit ones. Once
decided the platform, then it goes on to create a directory
**C:\\DC22,** this is its working directory. Before calling Sub\_402240
it disable 32 bit redirection with call
Wow64DisableWow64FsRedirection(). After creating its work directory it
calls Sub\_401C70(Char\* type, int Id) multiple times to copy the
decided, either 32-bit or 64-bit, resources from its .rsrc section to
C:\\DC22 directory, see fig 24. Once resource are copied, Sub\_401E001
calls to Sub\_40198( wchar\* dest\_buf, int buf\_len, wchar \*
driver\_dir, wchar \* system\_dir, wchar \* filename) to concatenate the
path for driver dcrypt, which is
**C:\\Windows\\System32\\driver\\dcrypt.sys**, then it installs the
driver by executing command **dcinst.exe -setup path\_to\_driver
target** from ShellExecute function. This can be seen in the figure 19,
and 20. After installation of dcrypt driver control returns back to
Sub\_402240 from Sub\_401E001, to create persistence Sub\_402240 goes on
to create a user of name **“mythbusters” with password 123456** with
command **“net user /add mythbusters 123456”** and add this user to
administrator group with command **“net localgroup administrators
mythbusters”** see fig. 23, 26, 14-a, and 14-b**.** Sub\_402240 also
creates a service with base image to itself. After creating service it
reboots the system. If bios access is enabled then user gets a notice
before even control goes to OS saying **“You are Hacked!!!!! Your HDD
Encrypted, Contact Us for Decryption Key (<w889901665@yandex.com>)
YourID : 123139”**, see fig. 17 . If bios access is disabled OS boots
and user is presented to login as **mythbusters** user see fig 18. All
other accounts are locked as user is not able to switch accounts. Upon
logging in with password 123456, service named 131.exe is found running
on the machine see fig 21. All the copied resource files can be seen in
C:\\DC22 directory. Dcrypt.sys driver can be seen in driver’s directory
see fig 19. Registry entry for service 131.exe can be seen with Regedit
see fig 22. Log file can be seen in fig 25. No network based activity is
observed during whole execution and even after reboot.

Indicators
==========

Host based indicator for this malware are listed below:

1.  Registry entries for the DegragmentService driver can be found with
    these keys:
    **HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet001\\Services\\DefragmentService,
    HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet002\\Services\\DefragmentService,
    HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\DefragmentService.**
    Image path is same for all these entries which is path to the
    original 131.exe where it was executed from.

2.  Registry entries for the dcrypt driver can be found with these keys:
    **HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet001\\Services\\dcrypt,
    HKEY\_LOCAL\_MACHINE\\SYSTEM\\ControlSet002\\Services\\dcrypt,
    HKEY\_LOCAL\_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\dcrypt.**
    Image path is system32\\drivers\\dcrypt.sys for all the three
    entries.

3.  Following files can be found in **C:\\DC22** directory**:**
    **dcrypt.sys, dcinst.exe, dcrypt.exe, dcapi.dll, dccon.exe,
    log\_file.txt, Mount.exe, netpass.exe, netpass.txt, and
    netuse.txt**.

4.  Dcrypt.sys driver can be found on **C:\\windows\\system32\\driver**
    directory.

5.  A user named **“mythbusters”** with password **123456** can be found
    on the machine.

Static Analysis Images
======================

![](media/image1.PNG){width="3.352221128608924in"
height="1.7270417760279966in"}

Figure 1 ExeinfoPE

![](media/image2.PNG){width="2.6252898075240596in"
height="2.8151246719160103in"}

Figure 2 PEID

![](media/image3.png){width="5.0103094925634295in"
height="3.320936132983377in"}

Figure 3 Kanal PEID

![](media/image4.PNG){width="5.690441819772529in"
height="2.805865048118985in"}

Figure 4 File header by PEstudio

![](media/image5.PNG){width="3.2141590113735785in"
height="2.6958759842519684in"}![](media/image6.PNG){width="2.9881364829396326in"
height="2.2268044619422573in"}

![](media/image7.PNG){width="4.469072615923009in"
height="4.747130358705162in"}

Figure 5 Indicators by PEStudio

![](media/image8.PNG){width="5.134825021872266in"
height="4.093043525809274in"}

![](media/image9.PNG){width="6.5in" height="2.0881944444444445in"}

Figure 6 Resource in PEstudio

![](media/image10.PNG){width="6.5in" height="2.902083333333333in"}

Figure 7 Sections PEstudio

![](media/image11.PNG){width="6.37in" height="5.08in"}

Figure 8 Strings PEstudio

![](media/image12.PNG){width="5.431153762029746in"
height="4.78293416447944in"}

Figure 9 Resources in Resource Hacker

![](media/image13.PNG){width="6.76713145231846in"
height="1.0309273840769904in"}

Figure 10 Hashes in HashmyFiles

Dynamic Analysis Images
=======================

![](media/image14.PNG){width="5.190387139107612in"
height="5.199646762904637in"}

Figure 11Procmon

![](media/image15.PNG){width="4.881443569553806in"
height="4.596968503937008in"}

Figure 12 131.exe running in
ProcessExplorer![](media/image16.PNG){width="5.81in" height="3.72in"}

Figure 13 Regshot

![](media/image17.PNG){width="6.3453608923884515in"
height="3.131327646544182in"}

Figure 14-a SUb\_402240 in IDA

![](media/image18.PNG){width="5.943299431321085in"
height="4.477158792650918in"}

Figure 14-b Sub\_402240 in Ollydbg creating user

![](media/image19.PNG){width="5.05in" height="4.38in"}

Figure 15 SUB\_401E00 in ida

![](media/image20.PNG){width="3.020618985126859in"
height="4.723360673665792in"}

Figure 16 Sub\_401C70 in IDA FindResource and LoadResource

![](media/image21.PNG){width="3.855670384951881in"
height="3.7166535433070864in"}

![](media/image22.PNG){width="5.241666666666666in"
height="3.7268044619422573in"}

![](media/image23.PNG){width="5.130194663167104in"
height="3.7041119860017497in"}

Figure 17 Notice on reboot

![](media/image24.png){width="5.623711723534559in"
height="3.722704505686789in"}

Figure 18 Login screen on reboot

![](media/image25.PNG){width="3.8291262029746282in"
height="2.0511515748031495in"}

Figure 19 dcrypt.sys driver in driver directory

![](media/image26.PNG){width="6.343291776027996in"
height="2.166905074365704in"}

Figure 20 dcrypt registry entry

![](media/image27.PNG){width="3.8152351268591427in"
height="1.347370953630796in"}

Figure 21 Defragment service status on reboot

![](media/image28.PNG){width="6.5in" height="1.9166666666666667in"}

Figure 22 Defragment service registry entry

![](media/image29.PNG){width="6.5in" height="1.3402066929133858in"}

Figure 23 Users on machine

![](media/image30.PNG){width="3.7735640857392827in"
height="2.1298643919510063in"}

Figure 24 Files in DC22 directory

![](media/image31.PNG){width="6.5in" height="3.051388888888889in"}

Figure 25 Log file of 131.exe

![](media/image32.PNG){width="3.546392169728784in"
height="3.976386701662292in"}

Figure 26 mythbusters user on login
